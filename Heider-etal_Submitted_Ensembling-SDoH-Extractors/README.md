
Sample Pipeline
---------------

Extracting Lexicons from brat
=============================

To create sample lexicons to feed into the post-hoc ensemble system,
you can extract the annotations from the training corpus and pass
these to medspaCy's MedspacyMatcher to create a simple pipeline.

```

python convert-n2c2-sdoh-brat-to-omop-cdm.py \
    --normalization lowercase \
    --min-term-length 3 \
    --types-file ${TYPESYSTEM_FILE} \
    --brat-root SHAC/train/mimic \
    --txt-root SHAC/train/mimic \
    --lxcn-root lexicons/v005/minLen3_lowercase
       
python lexical-sdoh.py \
    --types-file ${TYPES_FILE} \
    --lxcn-root lexicons/v005/minLen3_lowercase \
    --txt-root SHAC/train/mimic \
    --cas-root /tmp/output/v005_minLen3_lowercase
    
```

Stand-Alone Pipeline
====================

The script `subtaskA-example.sh` contains helper functions to navigate
the entire process from starting with the SHAC training corpus, to
extracting lexicons as stand-ins for for independent off-the-shelf
extractors, to training a decision template model, to applying the
decision template model, and finally scoring the model output.
Adjusting or localizing all the environment variables at the top of
this script should be sufficient to run the shell script.  The key
output of this script are the two scoring files (generated by the
official scoring script) and saved to `submission_a6_[ train | test ].csv`

Round Trip Conversion from SHAC brat to OMOP CDM
------------------------------------------------

Converting notes in the SHAC corpus away from the native brat format
will necessarily introduce gaps in the system.  We can evaluate a
round-trip conversion of the reference standard from brat to OMOP CDM
and back again to measure the expected performance ceiling introduced.
The shell script `round-trip.sh` provides the full process for
converting the MIMIC-III and UW subsets and then scoring
them. Comments in the shell script indicate how to localize the script
to run on your machine, including external resources that will need to
be downloaded. For the MIMIC-III subset of SHAC, the ceiling
F_1-measure after conversion was 0.7890. For the UW subset, the
ceiling F_1 was 0.7736.

```

## Convert from brat to OMOP CDM
python ${UTILS_DIR}/convert-n2c2-sdoh-brat-to-omop-cdm.py \
    --types-file ${TYPESYSTEM_FILE} \
    --txt-root ${SDOH_DIR}/${subset} \
    --brat-root ${SDOH_DIR}/${subset} \
    --cas-root ${OMOP_DIR}/${subset}

## Convert from OMOP CDM to brat
python ${UTILS_DIR}/convert-omop-cdm-to-n2c2-sdoh-brat.py \
    --types-file ${TYPESYSTEM_FILE} \
    --cas-root ${OMOP_DIR}/${subset} \
    --txt-root ${ROUNDTRIP_DIR}/${subset} \
    --brat-root ${ROUNDTRIP_DIR}/${subset}

## Score the original reference brat against
## the newly converted brat
python ${SCORING_DIR}/run_sdoh_scoring.py \
    ${SDOH_DIR}/${subset} \
    ${ROUNDTRIP_DIR}/${subset} \
    /tmp/scoringRoundTrip-${subset}.csv \
    --score_trig overlap \
    --score_span exact \
    --score_labeled label

```
